# Learn more about services, parameters and containers at
# http://symfony.com/doc/current/book/service_container.html
parameters:
    default_locale: de

    # parameter_name: value
    google_api_key: '%env(GOOGLE_API_KEY)%'
    twitter_api_key: '%env(TWITTER_API_KEY)%'
    twitter_api_secret: '%env(TWITTER_API_SECRET)%'
    twitter_access_token: '%env(TWITTER_ACCESS_TOKEN)%'
    twitter_access_secret: '%env(TWITTER_ACCESS_SECRET)%'
    
    # AI Parameters
    gemini_api_key: '%env(GEMINI_API_KEY)%'
    gemini_model: '%env(GEMINI_MODEL)%'
    gemini_base_url: 'https://generativelanguage.googleapis.com/v1beta'

services:
    # default configuration for services in *this* file
    _defaults:
        autowire: true      # Automatically injects dependencies in your services.
        bind:
            $twitter_api_key: '%twitter_api_key%'
            $twitter_api_secret: '%twitter_api_secret%'
            $twitter_access_token: '%twitter_access_token%'
            $twitter_access_secret: '%twitter_access_secret%'
        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.



    # makes classes in src/ available to be used as services
    # this creates a service per class whose id is the fully-qualified class name
    App\:
        resource: '../src/*'
        exclude: '../src/{DependencyInjection,Entity,Migrations,Tests,Kernel.php}'

    # controllers are imported separately to make sure services can be injected
    # as action arguments even if you don't extend any base controller class
    App\Controller\:
        resource: '../src/Controller'
        tags: ['controller.service_arguments']

    # add more service definitions when explicit configuration is needed
    # please note that last definitions always *replace* previous ones
    \Twig_Extensions_Extension_Intl:
        class: Twig_Extensions_Extension_Intl

    Google_Client:
        class: \Google_Client
        calls:
            - method: setApplicationName
              arguments:
                  - 'API Samples'

            - method: setDeveloperKey
              arguments:
                  - '%google_api_key%'

    Google_Service_YouTube:
        class: \Google_Service_YouTube
        arguments:
            - '@Google_Client'
    
    Google\Client:
        class: Google\Client
        calls:
            - method: setApplicationName
              arguments:
                  - 'API Samples'
            - method: setDeveloperKey
              arguments:
                  - '%google_api_key%'

    Google\Service\YouTube:
        class: Google\Service\YouTube
        arguments:
            - '@Google\Client'
    
    # AI Platform Services
    App\AI\GeminiProvider:
        arguments:
            $apiKey: '%gemini_api_key%'
            $model: '%gemini_model%'
            $baseUrl: '%gemini_base_url%'
        public: true
    
    App\AI\Platform\AIPlatform:
        calls:
            - method: addProvider
              arguments:
                - 'gemini'
                - '@App\AI\GeminiProvider'
            - method: setDefaultProvider
              arguments:
                - 'gemini'
        public: true
        
    App\AI\AIContentService:
        arguments:
            $enabled: true
        public: true
        
    # AI Service Aliases (public for testing)
    ai.content:
        alias: App\AI\AIContentService
        public: true
    ai.platform:
        alias: App\AI\Platform\AIPlatform
        public: true
    ai.gemini:
        alias: App\AI\GeminiProvider
        public: true
        
    # Sulu Document Manager Alias for API Controller
    Sulu\Component\DocumentManager\DocumentManagerInterface:
        alias: sulu_document_manager.document_manager
        public: true

    # AI Content Logger
    App\AI\Logger\AIContentLogger:
        arguments:
            $eventDispatcher: '@event_dispatcher'
        public: true
    
    # AI Commands with explicit database connection
    App\Command\AI\QuickGenerateCommand:
        arguments:
            $aiPlatform: '@App\AI\Platform\AIPlatform'
            $connection: '@doctrine.dbal.default_connection'
        tags: ['console.command']

    # YouTube Video Indexer (existing)
    App\Store\Indexer:
        arguments:
            $loader: '@App\Store\YouTubeChannelLoader'
            $transformer: '@Symfony\AI\Store\Document\Transformer\TextSplitTransformer'
            $indexer: '@ai.indexer.default'
            $chromaStore: '@App\Store\ChromaDBUpsertStore'
        public: true

    # Override the default ChromaDB store with our upsert version
    App\Store\ChromaDBUpsertStore:
        arguments:
            $client: '@Codewithkyrian\ChromaDB\Client'
            $collectionName: 'youtube_videos'

    # Replace the default store service
    ai.store.chroma_db.video:
        class: App\Store\ChromaDBUpsertStore
        arguments:
            $client: '@Codewithkyrian\ChromaDB\Client'
            $collectionName: 'youtube_videos'
        tags:
            - { name: 'ai.store' }
    
    App\Command\AI\GenerateCommand:
        arguments:
            $aiPlatform: '@App\AI\Platform\AIPlatform'
            $connection: '@doctrine.dbal.default_connection'
        tags: ['console.command']
    
    App\Command\AI\InteractiveGenerateCommand:
        arguments:
            $aiPlatform: '@App\AI\Platform\AIPlatform'
            $connection: '@doctrine.dbal.default_connection'
        tags: ['console.command']

    # Sulu Content Indexing Services
    App\Store\SuluContentLoader:
        arguments:
            $contentMapper: '@sulu.content.mapper'
            $webspaceManager: '@sulu_core.webspace.webspace_manager'
        public: true

    App\Store\SuluContentIndexer:
        arguments:
            $loader: '@App\Store\SuluContentLoader'
            $transformer: '@Symfony\AI\Store\Document\Transformer\TextSplitTransformer'
            $indexer: '@ai.indexer.sulu'
        public: true

    # ChromaDB store for Sulu content
    ai.store.chroma_db.sulu_content:
        class: App\Store\ChromaDBUpsertStore
        arguments:
            $client: '@Codewithkyrian\ChromaDB\Client'
            $collectionName: 'sulu_content'
        tags:
            - { name: 'ai.store' }

    # Sulu Content Search Tool for AI Agent
    App\Store\SuluContentSearch:
        arguments:
            $store: '@ai.store.chroma_db.sulu_content'
            $vectorizer: '@ai.vectorizer.openai_embeddings'
        public: true

    # Sulu Block Services (supports all 32 block types)
    App\Sulu\Block\BlockTypeRegistry:
        public: true

    App\Sulu\Block\BlockExtractor:
        arguments:
            $registry: '@App\Sulu\Block\BlockTypeRegistry'
        public: true

    App\Sulu\Block\BlockWriter:
        arguments:
            $registry: '@App\Sulu\Block\BlockTypeRegistry'
        public: true

    # HTTP Cache Clearer for MCP/CLI operations
    App\Sulu\Cache\HttpCacheClearer:
        arguments:
            $projectDir: '%kernel.project_dir%'
            $environment: '%kernel.environment%'

    # Sulu Page Service - Direct SQL (bypasses DocumentManager for MCP compatibility)
    App\Sulu\Service\PageService:
        arguments:
            $cacheManager: '@?sulu_http_cache.cache_manager'
            $fosCacheManager: '@?fos_http_cache.cache_manager'
            $blockTypeRegistry: '@App\Sulu\Block\BlockTypeRegistry'
            $blockExtractor: '@App\Sulu\Block\BlockExtractor'
            $blockWriter: '@App\Sulu\Block\BlockWriter'
            $documentManager: '@Sulu\Component\DocumentManager\DocumentManagerInterface'
            $httpCacheClearer: '@App\Sulu\Cache\HttpCacheClearer'
        public: true

    # MCP Tools
    App\MCP\Tools\SuluPagesTool:
        arguments:
            $pageService: '@App\Sulu\Service\PageService'
        tags: ['klp_mcp_server.tool']
        public: true

    # MCP OAuth Security
    App\Security\McpTokenAuthenticator:
        autoconfigure: true

    App\Security\McpUserProvider:
        autoconfigure: true

    App\Service\McpOAuthService:
        autoconfigure: true

