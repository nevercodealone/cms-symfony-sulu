version: '3'
services:
  webserver:
    container_name: $SHORTCODE1-web
    image: $IMAGE
    restart: unless-stopped
    networks:
      - proxy
      - db
    volumes:
      - var:/var/www/html/var
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.$SHORTCODE1.entrypoints=http"
      - "traefik.http.routers.$SHORTCODE1.rule=Host(`$URL`)"
      - "traefik.http.middlewares.$SHORTCODE1-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.$SHORTCODE1.middlewares=$SHORTCODE1-https-redirect"
      - "traefik.http.routers.$SHORTCODE1-secure.entrypoints=https"
      - "traefik.http.routers.$SHORTCODE1-secure.rule=Host(`$URL`)"
      - "traefik.http.routers.$SHORTCODE1-secure.tls=true"
      - "traefik.http.routers.$SHORTCODE1-secure.tls.certresolver=http"
      - "traefik.http.routers.$SHORTCODE1-secure.service=$SHORTCODE1"
      - "traefik.http.services.$SHORTCODE1.loadbalancer.server.port=80"
      - "traefik.docker.network=proxy"
    environment:
      - DATABASE_URL=$DATABASE_URL
      - DB_NAME=$DB_NAME
      - DB_HOST=$DB_HOST
      - DB_USER=$DB_USER
      - DB_PWD=$DB_PWD
      - APP_ENV=$APP_ENV
      - APP_SECRET=$APP_SECRET
      - GOOGLE_API_KEY=$GOOGLE_API_KEY
      - TWITTER_API_KEY=$TWITTER_API_KEY
      - TWITTER_API_SECRET=$TWITTER_API_SECRET
      - TWITTER_ACCESS_TOKEN=$TWITTER_ACCESS_TOKEN
      - TWITTER_ACCESS_SECRET=$TWITTER_ACCESS_SECRET
      - DEEPL_API_KEY=$DEEPL_API_KEY
      - GEMINI_API_KEY=$GEMINI_API_KEY
      - GEMINI_MODEL=$GEMINI_MODEL
      - OPENAI_API_KEY=$OPENAI_API_KEY
      - CHROMADB_HOST=$SHORTCODE1-chromadb
      - CHROMADB_PORT=8000
      - CHROMADB_DATABASE=$CHROMADB_DATABASE
      - AUTH0_DOMAIN=$AUTH0_DOMAIN
      - AUTH0_AUDIENCE=$AUTH0_AUDIENCE
      - MCP_ALLOWED_EMAILS=$MCP_ALLOWED_EMAILS
      - CORS_ALLOW_ORIGIN=^https?://.*\.nevercodealone\.de$$
  chromadb:
    container_name: $SHORTCODE1-chromadb
    image: chromadb/chroma:0.5.23
    restart: unless-stopped
    networks:
      - db
    volumes:
      - chromadb_data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
networks:
  proxy:
    external: true
  db:
    external: true
volumes:
  var:
  chromadb_data:
